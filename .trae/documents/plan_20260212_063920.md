# Migration Plan: Sequential Thinking to Code Mode Architecture

This plan outlines the steps to migrate the `sequential-thinking` MCP server to a modular "Code Mode" architecture,
separating business logic, TypeScript API, and MCP transport layers.

## Phase 1: Preparation & Analysis

- [x] Analyze existing codebase (`index.ts`, `index.test.ts`).
- [ ] Create new directory structure:
  - `src/core/`: Domain logic and types.
  - `src/codemode/`: Public TypeScript API.
  - `src/mcp/`: MCP Server implementation.
  - `tests/`: Organized test suite.

## Phase 2: Core Layer Implementation

- [ ] **Extract Types**: Create `src/core/types.ts` to define `ThoughtData` and result interfaces.
- [ ] **Extract Formatting**: Move `chalk`-based formatting logic to `src/core/formatter.ts`.
- [ ] **Extract Business Logic**: Create `src/core/tracker.ts` (or `model.ts`) to handle:
  - State management (`thoughtHistory`, `branches`).
  - Input validation (`validateThoughtData`).
  - Branch management logic.
  - _Note_: This layer will be pure TypeScript with no MCP dependencies.

## Phase 3: Code Mode Layer (The "Better Way")

- [ ] **Create API**: Implement `src/codemode/index.ts`.
  - Export a `SequentialThinking` class.
  - Method: `public think(input: ThoughtData): Promise<ThoughtResult>`.
  - Ensure strict typing and comprehensive JSDoc.
- [ ] **Unit Tests**: Create `tests/codemode/api.test.ts` to verify the API directly (replacing many of the old "server"
      tests).

## Phase 4: MCP Layer Adaptation

- [ ] **Tool Definition**: Move `SEQUENTIAL_THINKING_TOOL` definition to `src/mcp/tools.ts`.
- [ ] **Server Implementation**: Create `src/mcp/server.ts`.
  - Use `SequentialThinking` from the Code Mode layer to handle requests.
  - Maintain the existing `sequential-thinking-server` identity and version.
- [ ] **Entry Point**: Refactor `src/index.ts` to:
  - Export `createServer` from `mcp/server.ts`.
  - Handle `import.meta.main` for standalone execution.

## Phase 5: Verification & Testing

- [ ] **Migrate Tests**:
  - Split `index.test.ts` into `tests/core/tracker.test.ts`, `tests/codemode/api.test.ts`, and
    `tests/mcp/server.test.ts`.
- [ ] **Coverage Check**: Ensure >95% coverage.
- [ ] **Backward Compatibility**: Verify `bun start` still works and behaves exactly as before for JSON-RPC calls.

## Phase 6: Documentation & Finalization

- [ ] **Migration Log**: Create `MIGRATION_LOG.md` detailing changes.
- [ ] **Update README**: Document the new Code Mode API usage.
- [ ] **Cleanup**: Remove old monolithic files.
