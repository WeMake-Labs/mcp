# Collaborative Reasoning Code Mode Migration Plan

I will migrate the `collaborative-reasoning` MCP server to the new Code Mode architecture, separating concerns into Core, Code Mode, and MCP layers.

## 1. Directory Structure Setup
- Create the following directories within `src/collaborative-reasoning/src/`:
  - `core/`: For business logic and types.
  - `codemode/`: For the programmable TypeScript API.
  - `mcp/`: For the MCP protocol adapter.

## 2. Core Layer Implementation (`src/core/`)
- **`src/core/types.ts`**: Extract and move all interfaces:
  - `Persona`
  - `Contribution`
  - `Disagreement`
  - `CollaborativeReasoningData`
- **`src/core/logic.ts`**: Extract business logic from the current server class into a `CollaborativeReasoningManager` class.
  - Move validation, registry updates, history management, and visualization logic here.
  - Ensure methods return typed objects (`CollaborativeReasoningData`) instead of MCP response formats.

## 3. Code Mode Layer Implementation (`src/codemode/`)
- **`src/codemode/index.ts`**: Create the `CollaborativeReasoning` class.
  - This class will wrap `CollaborativeReasoningManager`.
  - Expose a public, strongly-typed API method: `collaborate(data: CollaborativeReasoningData): Promise<CollaborativeReasoningData>`.

## 4. MCP Layer Implementation (`src/mcp/`)
- **`src/mcp/tools.ts`**: Define the `COLLABORATIVE_REASONING_TOOL` definition and schema.
- **`src/mcp/server.ts`**: Implement the MCP server.
  - Instantiate the `CollaborativeReasoning` Code Mode class.
  - Map the `collaborativeReasoning` tool call to the Code Mode API.
  - Handle the visualization output and formatting for the MCP response.

## 5. Entry Point & Cleanup (`src/index.ts`)
- Update `src/index.ts` to:
  - Export the Code Mode API for direct usage.
  - Run the MCP server logic (imported from `src/mcp/server.ts`) when executed directly.

## 6. Testing & Validation
- Refactor `src/index.test.ts` to test the new Code Mode API.
- Verify that existing tests pass with the new structure.
- Add specific tests for the decoupled Core logic if needed.

## 7. Documentation
- Update `src/collaborative-reasoning/README.md` with:
  - New Code Mode usage examples.
  - Updated API documentation.
- Update `docs/MCP_CODE_MODE_MIGRATION.md` to check off `collaborative-reasoning` from the migration list.
