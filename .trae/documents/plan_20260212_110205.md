# Transaction Manager Code Mode Migration Plan

I will execute a comprehensive migration of the `transaction-manager` codebase to the Code Mode architecture, following
the established 3-layer pattern (Core, Code Mode, MCP).

## 1. Architecture Analysis & Design

The current implementation is a single-file MCP server (`src/server.ts`) mixed with business logic and Redis
interactions (`src/lib/redis-helper.ts`). The new architecture will separate these concerns:

- **Core Layer (`src/core/`)**: Pure business logic and types.
  - `types.ts`: Shared interfaces (`TxnRequestArgs`, `TxnResponse`).
  - `logic.ts`: The `TransactionLogic` class handling state transitions and Redis operations.
- **Code Mode Layer (`src/codemode/`)**: Programmable API.
  - `index.ts`: The `TransactionManager` class exposing typed methods (`start`, `resume`, `close`) to other modules.
- **MCP Layer (`src/mcp/`)**: Protocol Adapter.
  - `server.ts`: Handles JSON-RPC requests, validates inputs using Zod, and delegates to the Code Mode layer.

## 2. Migration Strategy

### Step 1: Directory Setup

- Create `src/transaction-manager/src/core`, `src/transaction-manager/src/codemode`, and
  `src/transaction-manager/src/mcp`.

### Step 2: Core Layer Implementation

- **Extract Types**: Move `TxnRequestArgs`, `TxnResponse`, and `TxnAction` to `src/core/types.ts`.
- **Extract Logic**: Create `src/core/logic.ts`.
  - Move the `switch (action)` logic from `handleTransactionCallback` into a class `TransactionLogic`.
  - Implement methods: `startTransaction`, `resumeTransaction`, `closeTransaction`.
  - Ensure methods return typed objects (e.g., `TxnResponse`), not MCP `CallToolResult`.
  - Keep dependencies on `redis-helper.ts`.

### Step 3: Code Mode Layer Implementation

- Create `src/codemode/index.ts`.
- Implement `TransactionManager` class that wraps `TransactionLogic`.
- Expose a clean, typed API for direct usage by other TS code/agents.

### Step 4: MCP Layer Implementation

- Create `src/mcp/server.ts` (and optionally `src/mcp/tools.ts` for schemas).
- Re-implement `createServer` and `handleTransactionCallback`.
- Instantiate `TransactionManager`.
- Map the "transaction" tool call to `TransactionManager` methods.
- Format responses as `CallToolResult`.

### Step 5: Entry Point & Cleanup

- Update `src/transaction-manager/src/index.ts` to export the Code Mode API (`TransactionManager`) and run the MCP
  server.
- Ensure `package.json` exports are correct.

## 3. Implementation Requirements

- **Refactoring**: Convert the switch-case handler into distinct methods in the Core layer.
- **Data Models**: Ensure `TxnResponse` is consistently used across layers.
- **Error Handling**: Core layer throws standard Errors; MCP layer catches and converts to `McpError` or error
  responses.
- **Dependencies**: `ioredis` usage remains in `redis-helper.ts`, called by Core.

## 4. Testing & Validation

- **Unit Tests**: Create tests for `TransactionLogic` (Core) and `TransactionManager` (Code Mode) in
  `src/transaction-manager/src/index.test.ts` (or split into `tests/`).
- **Integration Tests**: Verify the MCP server still works as expected using the existing tests (refactored to import
  the new server structure).
- **Validation**: Ensure "start", "resume", and "close" operations work with Redis (or mock).

## 5. Documentation

- Update `README.md` to document the new Code Mode API usage.
- Add TSDoc comments to the new classes and methods.
