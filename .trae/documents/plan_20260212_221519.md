I have analyzed the `multimodal-synthesizer` and the Code Mode architecture patterns. Here is the plan to migrate the server to the 3-layer architecture:

### 1. Structure Preparation
- Create directories: `src/core`, `src/codemode`, `src/mcp`.

### 2. Core Layer (`src/core/`)
- **`types.ts`**: Extract `MultimodalInput` and result interfaces.
- **`logic.ts`**: Move the pure `synthesize` function logic here.
- **Goal**: Zero dependencies on MCP SDK.

### 3. Code Mode Layer (`src/codemode/`)
- **`index.ts`**: Create a `MultimodalSynthesizer` class.
- **API**: Expose a typed `synthesize(input: MultimodalInput)` method.
- **Goal**: A clean, programmable API for LLMs/Scripts.

### 4. MCP Layer (`src/mcp/`)
- **`tools.ts`**: Define the `multimodalSynth` tool schema.
- **`server.ts`**: Implement the MCP server that wraps the `MultimodalSynthesizer` class.
- **Goal**: Handle protocol-specifics (JSON-RPC, stdio).

### 5. Entry Point & Cleanup (`src/index.ts`)
- Update `src/index.ts` to export the `MultimodalSynthesizer` class (for Code Mode usage).
- Add conditional execution to run the MCP server when executed directly.
- Remove old mixed code.

### 6. Testing & Verification
- Refactor `index.test.ts` to test the new `MultimodalSynthesizer` class directly.
- Verify the build and server startup.
